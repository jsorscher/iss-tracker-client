<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISS Tracker Sensor Client</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #111;
      color: #eee;
    }
    .label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Sensor Data</h1>
  <p><span class="label">Latitude:</span> <span id="lat">...</span></p>
  <p><span class="label">Longitude:</span> <span id="lon">...</span></p>
  <p><span class="label">Heading (True North):</span> <span id="heading">...</span></p>
  <p><span class="label">Magnetic Declination:</span> <span id="declination">...</span></p>
  <p><span class="label">Status:</span> <span id="status">Waiting for sensor data...</span></p>

  <script>
    let declination = 0;
    let lastCoords = null;

    async function fetchDeclination(lat, lon) {
      try {
        const response = await fetch(`https://www.ngdc.noaa.gov/geomag-web/calculators/calculateDeclination?lat1=${lat}&lon1=${lon}&resultFormat=json`);
        const data = await response.json();
        declination = data.result[0].declination;
        document.getElementById("declination").textContent = declination.toFixed(2) + "°";
      } catch (e) {
        console.error("Error fetching declination:", e);
        document.getElementById("declination").textContent = "Error";
      }
    }

    function updateHeading(alpha) {
      if (alpha == null) return;

      let trueHeading = alpha + declination;
      trueHeading = (trueHeading + 360) % 360;

      document.getElementById("heading").textContent = trueHeading.toFixed(2) + "°";
    }

    async function requestPermissionsIfNeeded() {
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      if (/iPad|iPhone|iPod/.test(ua) && typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
        try {
          const response = await DeviceOrientationEvent.requestPermission();
          if (response !== "granted") {
            document.getElementById("status").textContent = "Permission denied for device orientation.";
            return false;
          }
        } catch (err) {
          document.getElementById("status").textContent = "Orientation permission request failed.";
          console.error(err);
          return false;
        }
      }
      return true;
    }

    async function startSensors() {
      const permissionGranted = await requestPermissionsIfNeeded();
      if (!permissionGranted) return;

      document.getElementById("status").textContent = "Listening for sensor data...";

      window.addEventListener("deviceorientationabsolute", (event) => {
        if (event.absolute || typeof event.webkitCompassHeading !== "undefined") {
          let alpha = event.alpha;

          if (typeof event.webkitCompassHeading !== "undefined") {
            alpha = event.webkitCompassHeading;
          }

          updateHeading(alpha);
        }
      }, true);
    }

    if ("geolocation" in navigator) {
      navigator.geolocation.watchPosition((position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        document.getElementById("lat").textContent = lat.toFixed(6);
        document.getElementById("lon").textContent = lon.toFixed(6);

        const roundedCoords = [Math.round(lat * 10) / 10, Math.round(lon * 10) / 10].toString();
        if (roundedCoords !== lastCoords) {
          lastCoords = roundedCoords;
          fetchDeclination(lat, lon);
        }
      }, (err) => {
        console.error(err);
        document.getElementById("status").textContent = "Failed to get location.";
      }, { enableHighAccuracy: true });
    } else {
      document.getElementById("status").textContent = "Geolocation not supported.";
    }

    startSensors();
  </script>
</body>
</html>
